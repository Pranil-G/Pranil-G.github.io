<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WebView JS Bridge Probe</title>
  <style>body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:16px}pre{white-space:pre-wrap;word-wrap:break-word;background:#111;color:#dcdcdc;padding:12px;border-radius:6px}</style>
</head>
<body>
  <h2>WebView JS Bridge Probe</h2>
  <p>This page probes for common JS bridge objects used by the app and logs results below. It does not send data anywhere.</p>
  <button id="run">Run Probe</button>
  <button id="deepRun" title="Manual deep probe; may exercise additional native handlers">Deep Probe (manual)</button>
  <pre id="out">Ready. Click “Run Probe”.
</pre>

  <script>
    (function(){
      const out = document.getElementById('out');
      function log(...args){
        out.textContent += '\n' + args.map(a => (typeof a === 'string' ? a : JSON.stringify(a))).join(' ');
      }

      // Known bridge names found previously in the codebase
      const BRIDGES = [
        'OppoStoreClientBaseJS',
        'OppoStoreClientUserJS',
        'OppoStoreClientStoreJS',
        'OppoStoreClientUiJS',
        'OppoStoreClientAnalyticsJs',
        'OppoStoreClientDeviceJS',
        'HeytapNativeApi',
        'JSNewInterface',
        'duiba_app',
        'App_Js_Bridge',
        'ReactNativeWebView',
        'YouTubePlayerBridge'
      ];

      // Methods to try for each bridge (best-effort; calling some may trigger actions)
      const COMMON_METHODS = [
        'getToken','getAccessToken','getUserId','getOpenId','getPublicParameters','getAndroidID','getDeviceUUID','getInfo','getAppVersionName','getAppVersionCode'
      ];

      function safeCall(obj, name){
        try{
          const fn = obj[name];
          if(typeof fn === 'function'){
            try{
              const r = fn.length === 0 ? fn() : fn(); // try synchronous call
              return {ok:true, type: typeof r, value: r};
            }catch(e){
              return {ok:false, error: String(e)};
            }
          }
          return {ok:false, error: 'not a function'};
        }catch(e){
          return {ok:false, error: String(e)};
        }
      }

      function probeAll(){
        out.textContent = 'Probing...\n';
        BRIDGES.forEach(name => {
          try{
            const obj = window[name] || window[name.replace(/\W/g,'')];
            if(!obj){
              log(name + ': NOT FOUND');
              return;
            }
            log('--- ' + name + ' FOUND ---');
            log('typeof: ' + typeof obj);

            // list own properties
            try{
              const props = Object.keys(obj || {}).slice(0,200);
              log('properties ('+props.length+'):', props.join(', '));
            }catch(e){ log('properties: failed to list: ' + e); }

            // try some common getters
            COMMON_METHODS.forEach(m => {
              if(m in obj){
                const res = safeCall(obj, m);
                if(res.ok){
                  log(m + ' => ' + (res.value === undefined ? '(undefined)' : String(res.value)) );
                } else {
                  log(m + ' => ERROR: ' + res.error);
                }
              } else {
                // try lowercase/alternate names
                const alt = Object.keys(obj).find(k => k.toLowerCase() === m.toLowerCase());
                if(alt){
                  const res = safeCall(obj, alt);
                  log(alt + ' (alt for ' + m + ') => ' + (res.ok ? String(res.value) : ('ERROR: ' + res.error)));
                }
              }
            });

            // Report callable functions (limit)
            try{
              const fns = Object.keys(obj).filter(k => typeof obj[k] === 'function').slice(0,40);
              log('functions sample ('+fns.length+'):', fns.join(', '));
            }catch(e){ log('functions: failed to list: ' + e); }

            // Additional targeted probing for HeytapNativeApi
            if(name === 'HeytapNativeApi'){
              try{
                log('\n-- HeytapNativeApi targeted probes --');
                const tryPatterns = [
                  {fn:'invoke', args:['getToken']},
                  {fn:'invoke', args:['getAccessToken']},
                  {fn:'invoke', args:[]},
                  {fn:'invoke', args:[null]},
                  {fn:'invokeBatch', args:['[]']},
                  {fn:'broadcast', args:['probe_test']}
                ];
                tryPatterns.forEach(p => {
                  if(typeof obj[p.fn] === 'function'){
                    let r;
                    try{
                      r = obj[p.fn].apply(obj, p.args);
                      log(p.fn + '(' + JSON.stringify(p.args) + ') => ' + (r === undefined ? '(undefined)' : String(r)));
                    }catch(e){
                      log(p.fn + '(' + JSON.stringify(p.args) + ') => ERROR: ' + e);
                    }
                  } else {
                    log(p.fn + ' not present');
                  }
                });
              }catch(e){ log('Heytap probe failed: ' + e); }
            }

          }catch(e){
            log(name + ': probe exception: ' + e);
          }
        });
        log('\nProbe finished.');
      }

  document.getElementById('run').addEventListener('click', probeAll);
      // Run automatically shortly after load (helps when WebView injects interfaces after page load)
      window.addEventListener('load', function(){ setTimeout(probeAll, 500); });

      // Deep manual probe: tries a few common invocation shapes for HeytapNativeApi.
      function deepProbe(){
        out.textContent += '\n\n=== Deep Probe (manual) ===';
        const obj = window.HeytapNativeApi || window['HeytapNativeApi'.replace(/\W/g,'')];
        if(!obj){ log('HeytapNativeApi not present — cannot deep probe'); return; }

        // Helper: safe call for a named function on the object
        function tryCall(fnName, args){
          try{
            if(typeof obj[fnName] !== 'function'){
              log(fnName + ' not present');
              return;
            }
            const r = obj[fnName].apply(obj, args || []);
            log(fnName + '(' + JSON.stringify(args || []) + ') => ' + (r === undefined ? '(undefined)' : String(r)));
          }catch(e){
            log(fnName + '(' + JSON.stringify(args || []) + ') => ERROR: ' + e);
          }
        }

        // Non-destructive probes — these try to reveal schema/returns without issuing destructive commands.
        tryCall('invoke', ['getToken']);
        tryCall('invoke', ['getAccessToken']);
        tryCall('invoke', ['getUserInfo']);
        tryCall('invoke', []);
        try{
          // Try JSON payload shape
          if(typeof obj.invoke === 'function'){
            try{
              const r = obj.invoke(JSON.stringify({action:'probe', args:[]}));
              log('invoke(JSON) => ' + (r === undefined ? '(undefined)' : String(r)));
            }catch(e){ log('invoke(JSON) ERROR: ' + e); }
          }
        }catch(e){ log('invoke(JSON) ERROR: ' + e); }

        // invokeBatch if present
        tryCall('invokeBatch', [['getToken','getUserId']]);

        // broadcast (best-effort; may trigger app behavior) — still logged only
        tryCall('broadcast', ['probe_event']);

        // register a JS callback function and attempt to register it with native side
        window.probeCallback = function(data){ log('probeCallback invoked by native with: ' + JSON.stringify(data)); };
        try{
          if(typeof obj.registerBroadcastReceiver === 'function'){
            try{
              // Many register APIs expect (action, callbackName) or (callbackName). Try safe shapes.
              tryCall('registerBroadcastReceiver', ['probe_channel','probeCallback']);
              tryCall('registerBroadcastReceiver', ['probeCallback']);
            }catch(e){ log('registerBroadcastReceiver ERROR: ' + e); }
          } else {
            log('registerBroadcastReceiver not present');
          }
        }catch(e){ log('registerBroadcastReceiver overall ERROR: ' + e); }

        // mark button disabled after run
        try{ document.getElementById('deepRun').disabled = true; }catch(e){}
        out.textContent += '\n=== Deep Probe finished ===\n';
      }

      document.getElementById('deepRun').addEventListener('click', deepProbe);
    })();
  </script>
</body>
</html>
