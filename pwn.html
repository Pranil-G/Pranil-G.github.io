<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WebView JS Bridge Probe</title>
  <style>body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:16px}pre{white-space:pre-wrap;word-wrap:break-word;background:#111;color:#dcdcdc;padding:12px;border-radius:6px}</style>
</head>
<body>
  <h2>WebView JS Bridge Probe</h2>
  <p>This page probes for common JS bridge objects used by the app and logs results below. It does not send data anywhere.</p>
  <button id="run">Run Probe</button>
  <button id="deepRun" title="Manual deep probe; may exercise additional native handlers">Deep Probe (manual)</button>
  <button id="duibaRun" title="Manual duiba probes; non-destructive by default">Probe duiba_app (manual)</button>
  <pre id="out">Ready. Click “Run Probe”.
</pre>

  <div style="margin-top:12px;padding:8px;border:1px solid #ddd;border-radius:6px">
    <h3 style="margin:6px 0">duiba_app manual tester (safe)</h3>
    <p style="margin:6px 0">This section lets you call safe duiba_app methods and optionally test <code>launchActivity</code> with a pasted JSON payload. Do not run on production devices unless you understand the effects.</p>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button id="duiba_gets">getFromAppCode / getFromPkgName</button>
      <button id="duiba_copy">copyCode('poc-clipboard') (checks clipboard locally)</button>
      <button id="duiba_login">login()</button>
      <button id="duiba_render">renderMenu('{}')</button>
    </div>
    <div style="margin-top:8px">
      <label for="duiba_launch_input">launchActivity payload (JSON)</label><br>
      <textarea id="duiba_launch_input" style="width:100%;height:90px;box-sizing:border-box" placeholder='{"linkType":"NATIVE","linkUrl":"app://some","multiplePackages":[]}'>
      </textarea>
      <div style="margin-top:6px;display:flex;gap:8px">
        <button id="duiba_launch">Run launchActivity (requires confirm)</button>
        <button id="duiba_launch_preset" title="Insert a harmless preset example">Insert preset example</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const out = document.getElementById('out');
      function log(...args){
        out.textContent += '\n' + args.map(a => (typeof a === 'string' ? a : JSON.stringify(a))).join(' ');
      }

      // Known bridge names found previously in the codebase
      const BRIDGES = [
        'OppoStoreClientBaseJS',
        'OppoStoreClientUserJS',
        'OppoStoreClientStoreJS',
        'OppoStoreClientUiJS',
        'OppoStoreClientAnalyticsJs',
        'OppoStoreClientDeviceJS',
        'HeytapNativeApi',
        'JSNewInterface',
        'duiba_app',
        'App_Js_Bridge',
        'ReactNativeWebView',
        'YouTubePlayerBridge'
      ];

      // Methods to try for each bridge (best-effort; calling some may trigger actions)
      const COMMON_METHODS = [
        'getToken','getAccessToken','getUserId','getOpenId','getPublicParameters','getAndroidID','getDeviceUUID','getInfo','getAppVersionName','getAppVersionCode'
      ];

      function safeCall(obj, name){
        try{
          const fn = obj[name];
          if(typeof fn === 'function'){
            try{
              const r = fn.length === 0 ? fn() : fn(); // try synchronous call
              return {ok:true, type: typeof r, value: r};
            }catch(e){
              return {ok:false, error: String(e)};
            }
          }
          return {ok:false, error: 'not a function'};
        }catch(e){
          return {ok:false, error: String(e)};
        }
      }

      function probeAll(){
        out.textContent = 'Probing...\n';
        BRIDGES.forEach(name => {
          try{
            const obj = window[name] || window[name.replace(/\W/g,'')];
            if(!obj){
              log(name + ': NOT FOUND');
              return;
            }
            log('--- ' + name + ' FOUND ---');
            log('typeof: ' + typeof obj);

            // list own properties
            try{
              const props = Object.keys(obj || {}).slice(0,200);
              log('properties ('+props.length+'):', props.join(', '));
            }catch(e){ log('properties: failed to list: ' + e); }

            // try some common getters
            COMMON_METHODS.forEach(m => {
              if(m in obj){
                const res = safeCall(obj, m);
                if(res.ok){
                  log(m + ' => ' + (res.value === undefined ? '(undefined)' : String(res.value)) );
                } else {
                  log(m + ' => ERROR: ' + res.error);
                }
              } else {
                // try lowercase/alternate names
                const alt = Object.keys(obj).find(k => k.toLowerCase() === m.toLowerCase());
                if(alt){
                  const res = safeCall(obj, alt);
                  log(alt + ' (alt for ' + m + ') => ' + (res.ok ? String(res.value) : ('ERROR: ' + res.error)));
                }
              }
            });

            // Report callable functions (limit)
            try{
              const fns = Object.keys(obj).filter(k => typeof obj[k] === 'function').slice(0,40);
              log('functions sample ('+fns.length+'):', fns.join(', '));
            }catch(e){ log('functions: failed to list: ' + e); }

            // Additional targeted probing for HeytapNativeApi
            if(name === 'HeytapNativeApi'){
              try{
                log('\n-- HeytapNativeApi targeted probes --');
                const tryPatterns = [
                  {fn:'invoke', args:['getToken']},
                  {fn:'invoke', args:['getAccessToken']},
                  {fn:'invoke', args:[]},
                  {fn:'invoke', args:[null]},
                  {fn:'invokeBatch', args:['[]']},
                  {fn:'broadcast', args:['probe_test']}
                ];
                tryPatterns.forEach(p => {
                  if(typeof obj[p.fn] === 'function'){
                    let r;
                    try{
                      r = obj[p.fn].apply(obj, p.args);
                      log(p.fn + '(' + JSON.stringify(p.args) + ') => ' + (r === undefined ? '(undefined)' : String(r)));
                    }catch(e){
                      log(p.fn + '(' + JSON.stringify(p.args) + ') => ERROR: ' + e);
                    }
                  } else {
                    log(p.fn + ' not present');
                  }
                });
              }catch(e){ log('Heytap probe failed: ' + e); }
            }

          }catch(e){
            log(name + ': probe exception: ' + e);
          }
        });
        log('\nProbe finished.');
      }

  document.getElementById('run').addEventListener('click', probeAll);
      // Run automatically shortly after load (helps when WebView injects interfaces after page load)
      window.addEventListener('load', function(){ setTimeout(probeAll, 500); });

      // Install a safe window.HeytapJsApi.callback handler so native callbacks can be observed by this page.
      try{
        window.HeytapJsApi = window.HeytapJsApi || {};
        window.HeytapJsApi.callback = function(callbackId, data){
          try{
            log('HeytapJsApi.callback -> ' + callbackId + ' : ' + (typeof data === 'string' ? data : JSON.stringify(data)));
          }catch(e){
            log('HeytapJsApi.callback JSON stringify error: ' + e);
          }
        };
        // optional broadcastReceiver shim (some native code may call this pattern)
        window.HeytapJsApi.broadcastReceiver = window.HeytapJsApi.broadcastReceiver || function(cbId, data){
          log('HeytapJsApi.broadcastReceiver -> ' + cbId + ' : ' + JSON.stringify(data));
        };
      }catch(e){ log('install callback handler failed: ' + e); }

      // Deep manual probe: tries safe, correct-shaped invocation patterns for HeytapNativeApi.
      function deepProbe(){
        out.textContent += '\n\n=== Deep Probe (manual) ===';
        const obj = window.HeytapNativeApi || window['HeytapNativeApi'.replace(/\W/g,'')];
        if(!obj){ log('HeytapNativeApi not present — cannot deep probe'); return; }

        function safeTry(fnName, args){
          try{
            if(typeof obj[fnName] !== 'function'){
              log(fnName + ' not present');
              return;
            }
            const r = obj[fnName].apply(obj, args || []);
            log(fnName + '(' + JSON.stringify(args || []) + ') => ' + (r === undefined ? '(undefined)' : String(r)));
          }catch(e){
            log(fnName + '(' + JSON.stringify(args || []) + ') => ERROR: ' + e);
          }
        }

        // Prepare callback ids that the native layer will call via window.HeytapJsApi.callback(callbackId, data)
        const cb1 = 'probe_cb_getToken_' + Date.now();
        const cb2 = 'probe_cb_getAccessToken_' + Date.now();
        const cbBatch = 'probe_cb_batch_' + Date.now();
        const cbBrc = 'probe_cb_brc_' + Date.now();

        log('Deep probe: invoking with callback ids: ' + cb1 + ', ' + cb2 + ', ' + cbBatch);

        // 1) invoke with explicit args: (methodName, argumentsJsonString|null, callbackId)
        // Use null for no args when supported.
        try{
          if(typeof obj.invoke === 'function'){
            safeTry('invoke', ['getToken', null, cb1]);
            safeTry('invoke', ['getAccessToken', null, cb2]);
          } else {
            log('invoke not present');
          }
        }catch(e){ log('invoke overall ERROR: ' + e); }

        // 2) invokeBatch with a JSON array string of {method, arguments, callback_id}
        try{
          if(typeof obj.invokeBatch === 'function'){
            const batch = [
              {method: 'getToken', arguments: {}, callback_id: cbBatch + '_1'},
              {method: 'getUserId', arguments: {}, callback_id: cbBatch + '_2'}
            ];
            safeTry('invokeBatch', [JSON.stringify(batch)]);
          } else {
            log('invokeBatch not present');
          }
        }catch(e){ log('invokeBatch ERROR: ' + e); }

        // 3) registerBroadcastReceiver(action, callbackId) then send a broadcast to trigger it.
        try{
          if(typeof obj.registerBroadcastReceiver === 'function' && typeof obj.broadcast === 'function'){
            const action = 'probe_channel_' + Date.now();
            safeTry('registerBroadcastReceiver', [action, cbBrc]);
            // Give native a moment to register, then send a broadcast with an empty object payload.
            setTimeout(function(){
              try{ safeTry('broadcast', [action, '{}']); }catch(e){ log('broadcast call failed: ' + e); }
            }, 300);
          } else {
            log('registerBroadcastReceiver or broadcast not present');
          }
        }catch(e){ log('registerBroadcastReceiver overall ERROR: ' + e); }

        // mark button disabled after run to avoid accidental repeats
        try{ document.getElementById('deepRun').disabled = true; }catch(e){}
        out.textContent += '\n=== Deep Probe (manual) issued (await callbacks) ===\n';
      }

      document.getElementById('deepRun').addEventListener('click', deepProbe);

      // ------ duiba_app manual probes ------
      function getDuibaObj(){
        return window.duiba_app || window['duiba_app'.replace(/\W/g,'')];
      }

      function safeDuibaTry(fnName, args){
        const obj = getDuibaObj();
        if(!obj){ log('duiba_app not present'); return; }
        try{
          if(typeof obj[fnName] !== 'function'){
            log('duiba_app.' + fnName + ' not present');
            return;
          }
          const r = obj[fnName].apply(obj, args || []);
          log('duiba_app.' + fnName + '(' + JSON.stringify(args || []) + ') => ' + (r === undefined ? '(undefined)' : String(r)));
        }catch(e){ log('duiba_app.' + fnName + ' ERROR: ' + e); }
      }

      document.getElementById('duibaRun').addEventListener('click', function(){
        document.getElementById('duiba_gets').focus();
        log('\n--- duiba_app manual tester (ready) ---');
      });

      document.getElementById('duiba_gets').addEventListener('click', function(){
        // Non-destructive getters
        try{
          const obj = getDuibaObj();
          if(!obj){ log('duiba_app not present'); return; }
          // Attempt to call getters and log results
          ['getFromAppCode','getFromPkgName'].forEach(fn => {
            try{ if(typeof obj[fn] === 'function'){ const r = obj[fn](); log(fn + ' => ' + (r===undefined? '(undefined)': String(r))); } else { log(fn + ' not present'); } }catch(e){ log(fn + ' ERROR: ' + e); }
          });
        }catch(e){ log('duiba_gets ERROR: ' + e); }
      });

      document.getElementById('duiba_copy').addEventListener('click', function(){
        // copyCode is expected to copy to clipboard on device; we cannot read clipboard from this page reliably.
        safeDuibaTry('copyCode', ['poc-clipboard']);
        log('Note: check device clipboard manually after running this.');
      });

      document.getElementById('duiba_login').addEventListener('click', function(){
        // login() typically triggers the app login flow
        if(!confirm('duiba_app.login() may open a login UI. Run only on a test device. Continue?')) return;
        safeDuibaTry('login', []);
      });

      document.getElementById('duiba_render').addEventListener('click', function(){
        // renderMenu often expects a JSON argument
        try{ safeDuibaTry('renderMenu', ['{}']); }catch(e){ log('renderMenu ERROR: ' + e); }
      });

      document.getElementById('duiba_launch_preset').addEventListener('click', function(){
        const preset = JSON.stringify({linkType:'NATIVE',linkUrl:'app://example',multiplePackages:[]}, null, 2);
        document.getElementById('duiba_launch_input').value = preset;
        log('Inserted preset payload (harmless example).');
      });

      document.getElementById('duiba_launch').addEventListener('click', function(){
        try{
          const payload = document.getElementById('duiba_launch_input').value || '';
          if(!payload.trim()){ if(!confirm('Payload empty. Are you sure you want to call launchActivity with an empty string?')) return; }
          // Confirm explicit consent because this may start activities or show UX
          if(!confirm('Confirm: call duiba_app.launchActivity with the pasted JSON? Only run on test devices.')) return;
          safeDuibaTry('launchActivity', [payload]);
          log('launchActivity invoked (check logcat for resulting intents / activity starts).');
        }catch(e){ log('duiba_launch ERROR: ' + e); }
      });
    })();
  </script>
</body>
</html>
