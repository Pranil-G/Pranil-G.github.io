<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AppJsBridge probe</title>
</head>
<body>
  <h1>AppJsBridge probe</h1>
  <p>Probe logs appear below (prefixed with [probe]). If you use chrome://inspect you will also see console logs.</p>
  <pre id="probe-log" style="white-space:pre-wrap;background:#111;color:#dcdcdc;padding:10px;border-radius:6px;max-height:45vh;overflow:auto;font-family:monospace;font-size:13px"></pre>
  <script>
  (function(){
    const MAX_MS = 10000; // 10s timeout
    const INTERVAL = 300; // poll interval
    let elapsed = 0;
    const logContainer = document.getElementById('probe-log');
    function log(){
      try{
        const args = Array.prototype.slice.call(arguments);
        const text = args.map(function(a){ try{ return typeof a === 'string' ? a : JSON.stringify(a); } catch(e){ return String(a); } }).join(' ');
        const line = '[' + new Date().toISOString() + '] [probe] ' + text;
        // write to page
        if(logContainer){
          try{
            logContainer.textContent += line + '\n';
            // keep visible tail
            logContainer.scrollTop = logContainer.scrollHeight;
          } catch(e){}
        }
        // also emit to console for remote debugging
        try{ console.log.apply(console, ['[probe]'].concat(args)); } catch(e){}
      } catch(e){}
    }

    function tryGetApis(){
      try{
        if(window.appJsBridge && typeof window.appJsBridge.getAvailableApis === 'function'){
          try{
            const apis = window.appJsBridge.getAvailableApis();
            log('getAvailableApis() =>', apis);
          } catch(e){ log('getAvailableApis() threw', e); }
        } else {
          log('appJsBridge present but getAvailableApis() not available');
        }
      } catch(err){ log('error calling getAvailableApis', err); }
    }

    function check(){
      if(window.appJsBridge){
        log('bridge FOUND at', new Date().toISOString());
        tryGetApis();
        // also log presence of common helpers
        try{ log('has callApi?', !!(window.appJsBridge.callApi)); } catch(e){}
        done(true);
        return;
      }
      elapsed += INTERVAL;
      if(elapsed >= MAX_MS){
        log('bridge NOT FOUND after', MAX_MS, 'ms; will continue listening for JsBridgeReady event if it fires');
        done(false);
        return;
      }
      setTimeout(check, INTERVAL);
    }

    function onJsBridgeReady(evt){
      log('DOM event JsBridgeReady received at', new Date().toISOString());
      // re-check immediately when the event arrives
      setTimeout(check, 0);
    }

    function done(found){
      try{
        const summaryLine = '[probe] finished. found=' + found + ' -- ' + new Date().toISOString();
        log(summaryLine);
      } catch(e){}
      // keep page alive so you can inspect console
    }

    // Some bridge implementations push pending callbacks into window.bridgePendingCallbacks before injection completes.
    window.bridgePendingCallbacks = window.bridgePendingCallbacks || [];
    window.bridgePendingCallbacks.push(function(bridge){
      try{ log('bridgePendingCallbacks invoked, bridge=', bridge); if(bridge && bridge.getAvailableApis) log('bridge.getAvailableApis() =>', bridge.getAvailableApis()); } catch(e){ log('bridgePendingCallbacks handler error', e); }
    });

    // Listen for JsBridgeReady dispatched by the injected bootstrap script
    document.addEventListener('JsBridgeReady', onJsBridgeReady, false);

    // Start quick poll
    setTimeout(check, 50);
  })();
  </script>
</body>
</html>
